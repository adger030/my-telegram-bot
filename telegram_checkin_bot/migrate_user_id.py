import psycopg2
import os

DATABASE_URL = os.getenv("DATABASE_URL")

def get_conn():
    return psycopg2.connect(DATABASE_URL)

def migrate_user_ids(user_map):
    """
    user_map: dict[username -> user_id]
    éœ€è¦ä¼ å…¥å½“å‰æœºå™¨äººç¼“å­˜çš„ç”¨æˆ·å-å›ºå®šIDæ˜ å°„ï¼ˆå¯ä» Telegram API è·å– update.effective_userï¼‰
    """
    with get_conn() as conn:
        with conn.cursor() as cur:
            # 1ï¸âƒ£ è¡¥å…¨ users è¡¨
            for username, user_id in user_map.items():
                cur.execute("""
                    UPDATE users SET user_id = %s WHERE username = %s AND (user_id IS NULL OR user_id != %s)
                """, (user_id, username, user_id))
            print("âœ… å·²æ›´æ–° users è¡¨çš„ user_id")

            # 2ï¸âƒ£ è¡¥å…¨ messages è¡¨
            for username, user_id in user_map.items():
                cur.execute("""
                    UPDATE messages SET user_id = %s 
                    WHERE username = %s AND (user_id IS NULL OR user_id != %s)
                """, (user_id, username, user_id))
            print("âœ… å·²æ›´æ–° messages è¡¨çš„ user_id")

            conn.commit()


def find_missing_user_ids():
    """æ£€æŸ¥å“ªäº›è®°å½•ç¼ºå°‘ user_id"""
    with get_conn() as conn:
        with conn.cursor() as cur:
            cur.execute("SELECT DISTINCT username FROM users WHERE user_id IS NULL")
            missing_users = [row[0] for row in cur.fetchall()]
            cur.execute("SELECT DISTINCT username FROM messages WHERE user_id IS NULL")
            missing_msgs = [row[0] for row in cur.fetchall()]
    return set(missing_users) | set(missing_msgs)


if __name__ == "__main__":
    print("ğŸ” æ­£åœ¨æ£€æŸ¥ç¼ºå°‘ user_id çš„ç”¨æˆ·...")
    missing = find_missing_user_ids()
    if missing:
        print("ä»¥ä¸‹ç”¨æˆ·åç¼ºå°‘ user_idï¼Œè¯·æä¾›å¯¹åº”çš„ Telegram ID:")
        print(missing)
        # ç¤ºä¾‹æ˜ å°„ï¼ˆæ‰‹åŠ¨æˆ–ä»æœºå™¨äººç¼“å­˜/Telegram APIè·å–ï¼‰
        user_map = {
            "old_username1": 123456789,
            "old_username2": 987654321,
        }
        migrate_user_ids(user_map)
    else:
        print("âœ… æ‰€æœ‰ç”¨æˆ·å‡å·²è¡¥å…¨ user_idï¼Œæ— éœ€è¿ç§»")
