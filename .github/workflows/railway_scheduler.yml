name: â³ Railway å®šæ—¶å¼€å…³æœåŠ¡

on:
  schedule:
    # æ¯å¤© UTC 18:00ï¼ˆåŒ—äº¬æ—¶é—´ 02:00ï¼‰æ‰§è¡Œå…³é—­
    - cron: "0 18 * * *"
    # æ¯å¤© UTC 03:00ï¼ˆåŒ—äº¬æ—¶é—´ 11:00ï¼‰æ‰§è¡Œå¼€å¯
    - cron: "0 3 * * *"
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  railway-control:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ æ˜¾ç¤ºå½“å‰æ—¶é—´
        run: |
          echo "å½“å‰ UTC æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S')"
      
      - name: ğŸ“¦ æ‰§è¡Œ Railway æ§åˆ¶
        run: |
          # å®šä¹‰ GraphQL API
          API_URL="https://backboard.railway.app/graphql"
          
          # åˆ¤æ–­å½“å‰æ‰§è¡Œæ—¶é—´æ˜¯å…³è¿˜æ˜¯å¼€
          if [ "$(date -u '+%H')" == "18" ]; then
            ACTION="STOP"
          else
            ACTION="START"
          fi

          echo "æ‰§è¡Œæ“ä½œ: $ACTION"

          # GraphQL æŸ¥è¯¢
          if [ "$ACTION" == "STOP" ]; then
            QUERY="mutation { serviceInstanceDelete(id: \"${{ secrets.RAILWAY_SERVICE_ID }}\") { id } }"
          else
            QUERY="mutation { serviceInstanceCreate(input: { serviceId: \"${{ secrets.RAILWAY_SERVICE_ID }}\" }) { id } }"
          fi

          # è°ƒç”¨ API
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_API_KEY }}" \
            --data "{\"query\":\"$QUERY\"}" \
            $API_URL)

          echo "ğŸ“œ Railway API è¿”å›:"
          echo "$RESPONSE"

          # æ£€æŸ¥é”™è¯¯
          if echo "$RESPONSE" | grep -q "errors"; then
            echo "âŒ Railway API è°ƒç”¨å¤±è´¥"
            exit 1
          else
            echo "âœ… æ“ä½œæˆåŠŸ"
          fi
