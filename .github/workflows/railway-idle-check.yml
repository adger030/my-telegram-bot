name: Railway Idle Checker

on:
  schedule:
    - cron: '*/5 * * * *' # æ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡

jobs:
  idle-check:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æŸ¥ Railway ç©ºé—²çŠ¶æ€
        run: |
          echo "=== ğŸš€ Railway ç©ºé—²æ£€æµ‹å¼€å§‹ ==="
          echo "â° å½“å‰ UTC æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S')"

          # è°ƒç”¨ Railway API è·å–å˜é‡
          RAW=$(curl -s -X POST https://backboard.railway.app/graphql/v2 \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_API_KEY }}" \
            -d '{"query": "query { variables(serviceId: \"${{ secrets.SERVICE_ID }}\") { name value } }"}')

          echo "ğŸ“¦ Railway API åŸå§‹è¿”å›:"
          echo "$RAW"

          # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
          ERR_MSG=$(echo "$RAW" | jq -r '.errors[0].message // empty')
          if [ -n "$ERR_MSG" ]; then
            echo "âŒ Railway API é”™è¯¯: $ERR_MSG"
            exit 1
          fi

          # è·å– LAST_SEEN å˜é‡
          LAST_SEEN=$(echo "$RAW" | jq -r '.data.variables[]? | select(.name=="LAST_SEEN") | .value')
          if [ -z "$LAST_SEEN" ] || [ "$LAST_SEEN" = "null" ]; then
            echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ° LAST_SEEN å˜é‡ï¼Œå¯èƒ½æ˜¯ SERVICE_ID æˆ– RAILWAY_API_KEY é”™è¯¯ã€‚"
            exit 0
          fi

          echo "âœ… LAST_SEEN æ—¶é—´: $LAST_SEEN"

          # è®¡ç®—æ—¶é—´å·®ï¼ˆç§’ï¼‰
          NOW=$(date -u +%s)
          LAST_SEEN_TS=$(date -d "$LAST_SEEN" +%s)
          DIFF=$((NOW - LAST_SEEN_TS))

          echo "ğŸ•’ è·ç¦»ä¸Šæ¬¡æ´»è·ƒæ—¶é—´: $DIFF ç§’"

          if [ $DIFF -ge 600 ]; then
            echo "â›” å·²ç©ºé—²è¶…è¿‡ 10 åˆ†é’Ÿï¼Œæ­£åœ¨åœæ­¢ Railway æœåŠ¡..."
            STOP_RESP=$(curl -s -X POST https://backboard.railway.app/graphql/v2 \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.RAILWAY_API_KEY }}" \
              -d '{"query": "mutation { serviceStop(id: \"${{ secrets.SERVICE_ID }}\") { id } }"}')
            echo "ğŸ›‘ åœæ­¢æœåŠ¡è¿”å›: $STOP_RESP"
          else
            echo "âœ… æœåŠ¡ä»åœ¨è¿è¡Œï¼Œæ— éœ€åœæ­¢ã€‚"
          fi
