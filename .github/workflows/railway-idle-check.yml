name: Railway Idle Checker  # å·¥ä½œæµåç§°

on:
  schedule:
    - cron: '*/5 * * * *'  # æ¯ 5 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡

jobs:
  idle-check:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æŸ¥æœåŠ¡æ˜¯å¦ç©ºé—²
        run: |
          echo "=== ğŸš€ Railway ç©ºé—²æ£€æµ‹å¼€å§‹ ==="
          echo "â° å½“å‰ UTC æ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S")"

          # ä» Railway API è·å– LAST_SEENï¼ˆæœ€åä¸€æ¬¡æ´»è·ƒæ—¶é—´ï¼‰
          LAST_SEEN=$(curl -s -X POST https://backboard.railway.app/graphql/v2 \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.RAILWAY_API_KEY }}" \
          -d '{"query": "query { variables(serviceId: \"${{ secrets.SERVICE_ID }}\") { name value } }"}' \
          | jq -r '.data.variables[] | select(.name=="LAST_SEEN") | .value')

          # å¦‚æœæ²¡æ‹¿åˆ° LAST_SEENï¼Œç›´æ¥é€€å‡º
          if [ -z "$LAST_SEEN" ]; then
            echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ° LAST_SEEN æ•°æ®ï¼Œè·³è¿‡æ£€æµ‹..."
            exit 0
          fi

          # å½“å‰æ—¶é—´ï¼ˆç§’ï¼‰
          NOW=$(date -u +%s)
          # æœ€åæ´»è·ƒæ—¶é—´è½¬ä¸ºç§’
          LAST_SEEN_TS=$(date -d "$LAST_SEEN" +%s)
          # è®¡ç®—ç©ºé—²ç§’æ•°
          DIFF=$((NOW - LAST_SEEN_TS))

          echo "ğŸ“Œ æœ€åæ´»è·ƒæ—¶é—´: $LAST_SEEN (UTC)"
          echo "â³ è·ç¦»ä¸Šæ¬¡æ´»è·ƒå·²è¿‡å»: $DIFF ç§’"

          # å¦‚æœç©ºé—²æ—¶é—´ >= 600 ç§’ï¼ˆ10åˆ†é’Ÿï¼‰ï¼Œå°±åœæ‰æœåŠ¡
          if [ $DIFF -ge 600 ]; then
            echo "ğŸ›‘ æœåŠ¡å·²ç©ºé—²è¶…è¿‡ 10 åˆ†é’Ÿ â€” æ­£åœ¨åœæ­¢æœåŠ¡..."
            RESPONSE=$(curl -s -X POST https://backboard.railway.app/graphql/v2 \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_API_KEY }}" \
            -d '{"query": "mutation { serviceStop(id: \"${{ secrets.SERVICE_ID }}\") { id } }"}')
            echo "âœ… åœæ­¢è¯·æ±‚å·²å‘é€ï¼ŒRailway API è¿”å›ï¼š"
            echo "$RESPONSE"
          else
            echo "âœ… æœåŠ¡ä»ç„¶æ´»è·ƒï¼Œæ— éœ€æ“ä½œã€‚"
          fi

          echo "=== âœ… Railway ç©ºé—²æ£€æµ‹ç»“æŸ ==="
